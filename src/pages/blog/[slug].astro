---
export const prerender = false;

import { getPostInfo } from "@/services/wp";
import { formatDate, replaceHtmlEntities } from "@/utils/functions";
import { Schema } from "astro-seo-schema";
import BaseLayout from "@/layouts/BaseLayout.astro";
import BlockContainer from "@/components/global/BlockContainer.astro";
import TagH1 from "@/components/global/TagH1.astro";
import TagP from "@/components/global/TagP.astro";
import SharePost from "@/components/extras/SharePost.astro";

const { slug } = Astro.params;

const {
    title,
    content,
    date,
    seoTitle,
    seoDescription,
    featuredImage,
    seoType,
    categories,
    readingTime,
} = await getPostInfo(slug as string);

if (!title) {
    return new Response(null, { status: 404 });
}

const siteURL = new URL(Astro.url.pathname, Astro.site);

const seoMetaData = {
    title: seoTitle,
    description: seoDescription,
    metaTitle: seoTitle,
    image: featuredImage,
    metaType: seoType,
};
---

<BaseLayout seo={seoMetaData} offI18n={true}>
    {/* <!-- Schemas --> */}
    <Schema
        slot="schema-jsonld"
        item={{
            "@context": "https://schema.org",
            "@type": "BlogPosting",
            headline: title,
            image: featuredImage,
            datePublished: new Date(date).toISOString(),
            dateModified: new Date(date).toISOString(),
            description: seoDescription,
            publisher: {
                "@type": "Organization",
                "@id": siteURL.origin,
                name: "Snorkeling Adventure",
                logo: {
                    "@type": "ImageObject",
                    url: `${siteURL.origin}/assets/img/logos/logo-snorkel.png`,
                },
            },
            author: {
                "@type": "Organization",
                name: "Snorkeling Adventure",
                url: siteURL.origin,
            },
        }}
    />
    <Schema
        slot="schema-jsonld"
        item={{
            "@context": "https://schema.org",
            "@type": "BreadcrumbList",
            itemListElement: [
                {
                    "@type": "ListItem",
                    position: 1,
                    name: "Home",
                    item: siteURL.origin,
                },
                {
                    "@type": "ListItem",
                    position: 2,
                    name: "Blog",
                    item: `${siteURL.origin}/blog/`,
                },
                {
                    "@type": "ListItem",
                    position: 3,
                    name: title,
                    item: siteURL.href,
                },
            ],
        }}
    />
    <Schema
        slot="schema-jsonld"
        item={{
            "@context": "https://schema.org",
            "@type": "Article",
            mainEntityOfPage: {
                "@type": "WebPage",
                "@id": siteURL.href,
            },
            headline: title,
            image: {
                "@type": "ImageObject",
                url: featuredImage,
                width: "1000",
                height: "563",
            },
            author: {
                "@type": "Organization",
                name: "Snorkeling Adventure",
                url: siteURL.origin,
            },
            publisher: {
                "@type": "Organization",
                name: "Snorkeling Adventure",
                logo: {
                    "@type": "ImageObject",
                    url: `${siteURL.origin}/assets/img/logos/logo-snorkel.png`,
                    width: "600",
                    height: "60",
                },
            },
            datePublished: new Date(date).toISOString(),
            dateModified: new Date(date).toISOString(),
        }}
    />
    {/* Article Content */}
    <BlockContainer>
        <div class="max-w-4xl mx-auto my-20 mb-10">
            {
                categories.map((category: { slug: string; name: string }) => (
                    <div class="text-center mb-5">
                        <a
                            href={`/blog/category/${category.slug}/`}
                            aria-label={"View more posts of " + category.name}
                            class="block w-fit mx-auto bg-linear-to-br from-sky-700 via-sky-400 to-cyan-500 text-white font-semibold text-xs md:text-base rounded-full px-4 py-2"
                        >
                            {category.name}
                        </a>
                    </div>
                ))
            }
            {/* <!-- Header Post --> */}
            <TagH1 class="text-center break-words">
                {replaceHtmlEntities(title)}
            </TagH1>
            <div
                class="flex flex-wrap justify-center items-center gap-5 md:gap-10 text-zinc-500 font-normal"
            >
                <TagP>{formatDate(date)}</TagP>
                <TagP>{readingTime} read</TagP>
            </div>
            <img
                class="rounded-xl w-full h-full object-cover"
                fetchpriority="high"
                src={featuredImage}
                alt={seoTitle}
            />
        </div>
        <article
            class="prose md:prose-xl mx-auto prose-img:mx-auto prose-img:w-full prose-img:rounded-lg prose-img:mb-4 flex flex-wrap"
        >
            <div
                class="order-2 lg:order-none w-full lg:w-11/12 text-base/loose mx-auto break-words prose-p:text-justify prose-a:font-semibold prose-a:text-cyan-600 prose-a:hover:text-cyan-500 prose-a:transition prose-a:duration-200 prose-a:underline! prose-a:decoration-2! prose-a:decoration-cyan-600"
                set:html={content}
            />
            <SharePost siteURL={siteURL} textCopy="Copied!" />
        </article>
    </BlockContainer>
    <style is:inline>
        .wp-block-code {
            background-color: #f8f8f8;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
        }
    </style>
</BaseLayout>
